# webmiddle-server

> Easily turns webmiddle applications into REST APIs, allowing remote access via HTTP or WebSocket.

## Install

```bash
npm install --save webmiddle-server
```

## Usage

Given some routes that map paths to services, create a server listening on port 3000:

```jsx
import Server from "webmiddle-server";
import { createContext } from "webmiddle";

const textResource = (content, name = "result") => ({
  name,
  contentType: "text/plain",
  content:
    typeof content !== "undefined" && content !== null
      ? String(content)
      : content
});

const server = new Server({
  "math/multiply": ({ a, b }) => textResource(a * b),
  "math/divide": ({ a, b }) => textResource(a / b))
}, {
  port: 3000,
  context: createContext({ retries: 2 }), // default context
});
server.start();
```

## How it works

### Endpoints:

- `/services/`: lists all the service paths.
- `/services/foo/bar`: executes the service at path `foo.bar`.

Endpoints can be called by using both GET, POST or WEBSOCKET requests.

### GET requests:
- The query parameters are used as service props.
- There is no way to pass context options.

### POST requests:
- In this case you explicitly need to pass a JSON object in the request body, composed of the following properties:
  - `props`: the properties to pass to the service.
  - `options`: an optional object containing the context options to use.
  
### WEBSOCKET requests:
The request is a message with the following format:

```javascript
{ type: 'request', requestId, path, body }
```

- `requestId` is an unique identifier for the request, must be generated by the client with libraries such as [uuid](https://www.npmjs.com/package/uuid).
- `path`: the request endpoint.
- `body`: the request body, as in POST requests.

The server will eventually respond with the following message:

```javascript
{ type: 'response', requestId, status, body }
```

- `status`: can be "success" or "error".
- `body`: the response body.

### Response

In case of error, the response will have status `500` (for GET and POST requests) and the error string as the body.

In case of success, the response body will always be a JSON object representing a resource.  
If the evaluated output isn't already a resource, then such output will be wrapped into a resource having the `x-webmiddle-any` contentType.
